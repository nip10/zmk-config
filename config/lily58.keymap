/*
 * Portuguese (PT-PT) QWERTY layout for Lily58
 *
 * macOS setup: System Settings > Keyboard > Input Sources > add "Portuguese"
 *
 * HID keycodes are position-based (US layout), but macOS Portuguese layout
 * interprets them as Portuguese characters. Comments show what each key
 * actually produces.
 *
 * Dead keys on base layer (right column):
 *   RBKT  = ´ dead key  → then vowel: á é í ó ú   (Shift: ` → à)
 *   BSLH  = ~ dead key  → then vowel: ã õ          (Shift: ^ → â ê ô)
 *   SEMI  = ç            (Shift: Ç)
 *
 * Accent workflow:
 *   1. Tap ´ (right of P)
 *   2. Tap a vowel (a, e, i, o, u)
 *   3. Get the accented character (á, é, í, ó, ú)
 *   Same for ~→ã/õ, Shift+´→à, Shift+~→â/ê/ô
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/ext_power.h>

#define DEFAULT 0
#define LOWER   1
#define RAISE   2

/ {
    keymap {
        compatible = "zmk,keymap";

        default_layer {
            // ┌─────┬─────┬─────┬─────┬─────┬─────┐                    ┌─────┬─────┬─────┬─────┬─────┬─────┐
            // │ ESC │  1  │  2  │  3  │  4  │  5  │                    │  6  │  7  │  8  │  9  │  0  │BKSP │
            // ├─────┼─────┼─────┼─────┼─────┼─────┤                    ├─────┼─────┼─────┼─────┼─────┼─────┤
            // │ TAB │  Q  │  W  │  E  │  R  │  T  │                    │  Y  │  U  │  I  │  O  │  P  │  ´~ │
            // ├─────┼─────┼─────┼─────┼─────┼─────┤                    ├─────┼─────┼─────┼─────┼─────┼─────┤
            // │CTRL │  A  │  S  │  D  │  F  │  G  │                    │  H  │  J  │  K  │  L  │  Ç  │  ~^ │
            // ├─────┼─────┼─────┼─────┼─────┼─────┼──────┐    ┌───────┼─────┼─────┼─────┼─────┼─────┼─────┤
            // │SHIFT│  Z  │  X  │  C  │  V  │  B  │ +/*  │    │  º/ª  │  N  │  M  │  ,  │  .  │  -  │SHIFT│
            // └─────┴─────┴─────┼─────┼─────┼─────┼──────┤    ├───────┼─────┼─────┼─────┼─────┴─────┴─────┘
            //                   │ OPT │ CMD │LOWER│SPACE │    │ ENTER │RAISE│BKSP │ CMD │
            //                   └─────┴─────┴─────┴──────┘    └───────┴─────┴─────┴─────┘
            //
            // Key:  ´~ means ´ (acute dead key), Shift gives ` (grave dead key)
            //       ~^ means ~ (tilde dead key), Shift gives ^ (circumflex dead key)
            //       +/* means + (plus), Shift gives * (asterisk)
            //       º/ª means º (masc ordinal), Shift gives ª (fem ordinal)

            bindings = <
                &kp ESC   &kp N1 &kp N2 &kp N3   &kp N4   &kp N5                        &kp N6 &kp N7 &kp N8    &kp N9  &kp N0   &kp BSPC
                &kp TAB   &kp Q  &kp W  &kp E    &kp R    &kp T                         &kp Y  &kp U  &kp I     &kp O   &kp P    &kp RBKT
                &kp LCTRL &kp A  &kp S  &kp D    &kp F    &kp G                         &kp H  &kp J  &kp K     &kp L   &kp SEMI &kp BSLH
                &kp LSHFT &kp Z  &kp X  &kp C    &kp V    &kp B    &kp LBKT   &kp SQT   &kp N  &kp M  &kp COMMA &kp DOT &kp FSLH &kp RSHFT
                                        &kp LALT &kp LGUI &mo LOWER &kp SPACE &kp RET   &mo RAISE &kp BSPC &kp RGUI
            >;

            sensor-bindings = <&inc_dec_kp C_VOL_UP C_VOL_DN>;
        };

        lower_layer {
            // Symbols + F-keys + Bluetooth
            //
            // ┌─────┬─────┬─────┬─────┬─────┬─────┐                    ┌─────┬─────┬─────┬─────┬─────┬─────┐
            // │ F12 │ F1  │ F2  │ F3  │ F4  │ F5  │                    │ F6  │ F7  │ F8  │ F9  │ F10 │ F11 │
            // ├─────┼─────┼─────┼─────┼─────┼─────┤                    ├─────┼─────┼─────┼─────┼─────┼─────┤
            // │     │  !  │  "  │  #  │  $  │  %  │                    │  &  │  /  │  (  │  )  │  =  │ DEL │
            // ├─────┼─────┼─────┼─────┼─────┼─────┤                    ├─────┼─────┼─────┼─────┼─────┼─────┤
            // │     │  «  │  »  │  €  │  '  │  ?  │                    │  @  │  [  │  ]  │  {  │  }  │  \  │
            // ├─────┼─────┼─────┼─────┼─────┼─────┼──────┐    ┌───────┼─────┼─────┼─────┼─────┼─────┼─────┤
            // │     │BTCLR│ BT0 │ BT1 │ BT2 │ BT3 │      │    │       │  |  │  ;  │  :  │  _  │  *  │     │
            // └─────┴─────┴─────┼─────┼─────┼─────┼──────┤    ├───────┼─────┼─────┼─────┼─────┴─────┴─────┘
            //                   │     │     │     │      │    │       │     │ DEL │     │
            //                   └─────┴─────┴─────┴──────┘    └───────┴─────┴─────┴─────┘
            //
            // Notes on PT layout HID mappings:
            //   Shift+2 = "    Shift+6 = &    Shift+7 = /
            //   Shift+0 = =    EQUAL pos = «   Shift+EQUAL = »
            //   MINUS pos = '  Shift+MINUS = ?
            //   Shift+COMMA = ;  Shift+DOT = :
            //   Shift+FSLH = _   Shift+LBKT = *
            //   GRAVE pos = \    Shift+GRAVE = |
            //   Option+N2 = @  Option+N8 = [  Option+N9 = ]
            //   Option+Shift+N8 = {  Option+Shift+N9 = }
            //   Option+E = €

            bindings = <
                &kp F12   &kp F1       &kp F2       &kp F3       &kp F4       &kp F5                          &kp F6       &kp F7       &kp F8          &kp F9          &kp F10      &kp F11
                &trans    &kp LS(N1)   &kp LS(N2)   &kp LS(N3)   &kp LS(N4)   &kp LS(N5)                      &kp LS(N6)   &kp LS(N7)   &kp LS(N8)      &kp LS(N9)      &kp LS(N0)   &kp DEL
                &trans    &kp EQUAL    &kp LS(EQUAL) &kp RA(E)   &kp MINUS    &kp LS(MINUS)                    &kp RA(N2)   &kp RA(N8)   &kp RA(N9)      &kp RA(LS(N8))  &kp RA(LS(N9)) &kp GRAVE
                &trans    &bt BT_CLR   &bt BT_SEL 0 &bt BT_SEL 1 &bt BT_SEL 2 &bt BT_SEL 3  &trans   &trans   &kp LS(GRAVE) &kp LS(COMMA) &kp LS(DOT)  &kp LS(FSLH)    &kp LS(LBKT) &trans
                                                    &trans       &trans       &trans         &trans   &trans   &trans       &kp DEL      &trans
            >;

            sensor-bindings = <&inc_dec_kp C_VOL_UP C_VOL_DN>;
        };

        raise_layer {
            // Navigation + Numbers
            //
            // ┌─────┬─────┬─────┬─────┬─────┬─────┐                    ┌─────┬─────┬─────┬─────┬─────┬─────┐
            // │     │     │     │     │     │     │                    │     │     │     │     │     │     │
            // ├─────┼─────┼─────┼─────┼─────┼─────┤                    ├─────┼─────┼─────┼─────┼─────┼─────┤
            // │     │  1  │  2  │  3  │  4  │  5  │                    │  6  │  7  │  8  │  9  │  0  │     │
            // ├─────┼─────┼─────┼─────┼─────┼─────┤                    ├─────┼─────┼─────┼─────┼─────┼─────┤
            // │     │     │     │     │     │     │                    │  ←  │  ↓  │  ↑  │  →  │     │     │
            // ├─────┼─────┼─────┼─────┼─────┼─────┼──────┐    ┌───────┼─────┼─────┼─────┼─────┼─────┼─────┤
            // │     │     │     │     │     │     │      │    │       │HOME │PG_DN│PG_UP│ END │     │     │
            // └─────┴─────┴─────┼─────┼─────┼─────┼──────┤    ├───────┼─────┼─────┼─────┼─────┴─────┴─────┘
            //                   │     │     │     │      │    │       │     │ DEL │     │
            //                   └─────┴─────┴─────┴──────┘    └───────┴─────┴─────┴─────┘

            bindings = <
                &trans    &trans &trans &trans   &trans   &trans                        &trans   &trans    &trans    &trans    &trans &trans
                &trans    &kp N1 &kp N2 &kp N3   &kp N4   &kp N5                      &kp N6   &kp N7    &kp N8    &kp N9    &kp N0 &trans
                &trans    &trans &trans &trans   &trans   &trans                        &kp LEFT &kp DOWN  &kp UP    &kp RIGHT &trans &trans
                &trans    &trans &trans &trans   &trans   &trans   &trans    &trans      &kp HOME &kp PG_DN &kp PG_UP &kp END   &trans &trans
                                       &trans   &trans   &trans   &trans    &trans      &trans   &kp DEL   &trans
            >;

            sensor-bindings = <&inc_dec_kp C_VOL_UP C_VOL_DN>;
        };
    };
};
